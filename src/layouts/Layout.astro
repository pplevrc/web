---
import type { OptionalIconType } from "@components/decoratives/Vectors/Icon/types";
import type { OptionalLogoIconType } from "@components/decoratives/Vectors/LogoIcon/types";
import type { ShapeType } from "@components/decoratives/Vectors/Shapes/types";
import CookieConsent from "@components/layouts/CookieConcent/CookieConcent.astro";
import Footer from "@components/layouts/Footer/Footer.astro";
import Header from "@components/layouts/Header/Header.astro";
import {
  type DescriptionMetaProps,
  default as HeadMeta,
  type OGPProps,
  type SNSProps,
} from "@components/layouts/HeadMeta";
import type { OGPMetadata } from "@components/layouts/HeadMeta/internals/ogpType";
import { default as TemplateDefinition } from "@components/layouts/TemplateDefinition/TemplateDefinition.astro";
import type { ColorThemeBase } from "@content/commons";
import { getMeta } from "@content/meta";
import { GTM_ID, IS_PUBLIC } from "@lib/utils/env";
import { css, cva } from "@styles/css";
import type { NodeObject } from "jsonld";

interface Props {
  headMeta: DescriptionMetaProps;
  ogp?: OGPProps;
  sns?: SNSProps;
  jsonLd?: NodeObject | NodeObject[];
  defineIcons?: OptionalIconType[];
  defineLogos?: OptionalLogoIconType[];
  defineShapes?: ShapeType[];
  themeColor?: ColorThemeBase;
  polyfill?: {
    invokers?: boolean;
    anchorPosition?: boolean;
  };

  mainClass?: string;
  "mainClass:list"?: string[];
  rootClass?: string;
  "rootClass:list"?: string[];
}

const {
  ogp,
  sns,
  jsonLd,
  headMeta: { title, description, keywords },
  defineIcons,
  defineLogos,
  defineShapes,
  polyfill,
  mainClass,
  "mainClass:list": mainClassList = [],
  rootClass,
  "rootClass:list": rootClassList = [],
  themeColor,
} = Astro.props;

const {
  official: { cookieConcent },
} = await getMeta();

// OGPProps から OGPMetadata に変換（url を追加）
const ogpMetadata: OGPMetadata | undefined = ogp
  ? {
      ...(ogp as Omit<OGPMetadata, "url">),
      url: Astro.url.href,
    }
  : undefined;

const hideScroll = css({
  _spOnly: {
    "&:has(header *:checked)": {
      overflow: "hidden",
    },
  },
});

const backgroundClassRecipe = cva({
  base: {
    pos: "relative",

    _before: {
      content: "''",
      pos: "absolute",
      top: "0",
      left: "0",
      width: "full",
      height: "full",
      bgSize: "[5.0625rem, 5.0625rem]",
      zIndex: "backgroundBase",
    },
  },
  variants: {
    color: {
      smoke: {
        _before: {
          bgGradient: "smoke.checkered",
        },
      },
      olive: {
        _before: {
          bgGradient: "olive.checkered",
        },
      },
      berry: {
        _before: {
          bgGradient: "berry.checkered",
        },
      },
      honey: {
        _before: {
          bgGradient: "honey.checkered",
        },
      },
      soda: {
        _before: {
          bgGradient: "soda.checkered",
        },
      },
      rose: {
        _before: {
          bgGradient: "rose.checkered",
        },
      },
      matcha: {
        _before: {
          bgGradient: "matcha.checkered",
        },
      },
      latte: {
        _before: {
          bgGradient: "latte.checkered",
        },
      },
      lavender: {
        _before: {
          bgGradient: "lavender.checkered",
        },
      },
      carrot: {
        _before: {
          bgGradient: "carrot.checkered",
        },
      },
      ice: {
        _before: {
          bgGradient: "ice.checkered",
        },
      },
      mint: {
        _before: {
          bgGradient: "mint.checkered",
        },
      },
    },
  },
  defaultVariants: {
    color: "smoke",
  },
});

const backgroundClass = backgroundClassRecipe({ color: themeColor });
---

<!doctype html>
<html lang="ja" dir="ltr">
  <head>
    <slot name="head" />
    <HeadMeta
      title={title}
      description={description}
      keywords={keywords}
      polyfill={polyfill}
      themeColor={themeColor ?? "smoke"}
      ogp={ogpMetadata}
      sns={sns}
      jsonLd={jsonLd}
    />
  </head>

  <body class:list={[hideScroll, rootClass, ...rootClassList]}>
    <TemplateDefinition
      defineIcons={defineIcons}
      defineLogos={defineLogos}
      defineShapes={defineShapes}
    >
      <slot name="template-definition" />
    </TemplateDefinition>
    <Header />
    <main class:list={[backgroundClass, mainClass, ...mainClassList]}>
      <slot />
    </main>
    <Footer />
    {
      IS_PUBLIC && GTM_ID ? (
        <CookieConsent cookieConcentHtml={cookieConcent} />
      ) : null
    }
  </body>
</html>
