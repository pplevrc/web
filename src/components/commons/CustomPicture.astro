---
import { Picture } from "astro:assets";
import type { CustomImageTransform } from "@lib/services/custom-sharp";

export interface Props extends CustomImageTransform {}

const isProduction = import.meta.env.MODE === "production";

const props = (() => {
  if (isProduction) {
    return Astro.props;
  }

  // 開発モードでは cache を使わずに常に SSR で画像が変換されてしまうので, 重くなる要因を排除したオプションに変更する
  const p = { ...Astro.props };
  p.widths = undefined;
  p.sizes = undefined;
  p.formats = ["png"];
  return p;
})();

// biome-ignore lint/suspicious/noExplicitAny: Astro では Image Service を拡張しても, それを利用する Image 系コンポーネントの型を拡張する術がないため, any でエラーを回避している
const WrappedPicture = Picture as any;
---

<WrappedPicture {...props} />
