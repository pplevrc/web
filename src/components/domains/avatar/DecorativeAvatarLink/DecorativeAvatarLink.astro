---
import NameSeal from "@/components/decoratives/Shape/NameSeals/NameSeals.astro";
import OrigamiShape from "@/components/decoratives/Shape/OrigamiShape/OrigamiShape.astro";
import { randomPick, seedRandom } from "@/lib/utils/random";
import { fetchCast } from "@lib/contents/casts";
import { pickColorBase } from "@lib/contents/commons/ColorToken";
import { css } from "@styles/css";
// biome-ignore lint/style/useImportType: なぜか Biome がエラーにしてくるので回避
import AvatarImage from "../AvatarImage/AvatarImage.astro";
import StripeCircle from "./internals/StripeCircle.astro";

type AvatarImageProps = Omit<Parameters<typeof AvatarImage>[0], "alt">;

interface Props extends AvatarImageProps {}

const { class: className, ...avatarImageProps } = Astro.props;

const { nickname } = avatarImageProps;

const { themeColor } = await fetchCast(nickname);

if (!themeColor) {
  throw new Error(
    `themeColor is required, but cast data of ${nickname} has no themeColor`,
  );
}

const rootStyle = css({
  w: "32",
  h: "full",
  overflow: "visible",

  "& *": {
    pointerEvents: "none",
  },
});

const figureRoot = css({
  w: "[inherit]",
  h: "[inherit]",
  pos: "relative",
});

const origamiStyle = css({
  pos: "absolute",
  transform: "[translate(-50%, -50%)]",
  left: "[50%]",
  top: "[50%]",
});

const imageStyle = css({
  pos: "absolute",
  bottom: "0",
  left: "[50%]",
  transform: "[translate(-50%, 0)]",
  display: "block",
});

const circleStyle = css({
  pos: "absolute",
  left: "[50%]",
  top: "[50%]",
  transform: "[translate(-50%, -50%)]",
});

const nameStyle = css({
  pos: "absolute",
  left: "[50%]",
  top: "[50%]",
  transform: "[translate(-50%, -50%)]",
});

const random = seedRandom(nickname);

const shapeType = randomPick(1, [0, 1, 2, 3, 4, 5, 6, 7, 8] as const, random);

const rotateType = randomPick(
  1,
  /**
   * 90, 270 度以外の角度の比重を重くする (3, 9)
   */
  [
    0, 0, 1, 1, 2, 2, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 10, 10, 11, 11,
  ] as const,
  random,
);

const inverse = randomPick(1, [true, false] as const, random);

const colorName = pickColorBase(themeColor);
---

<a
  class:list={[rootStyle, className]}
  href={`/cast/${nickname}`}
  aria-label={`店員"${nickname}"の紹介ページ`}
>
  <figure class={figureRoot}>
    <OrigamiShape
      shape={shapeType}
      rotate={rotateType}
      inverse={inverse}
      color={colorName}
      class={origamiStyle}
    />
    <StripeCircle class={circleStyle} />
    <AvatarImage
      {...avatarImageProps}
      class={imageStyle}
      alt={`${nickname} のアバター`}
      aria-hidden
    />
    <NameSeal class={nameStyle} color={themeColor} name={nickname} />
  </figure>
</a>
