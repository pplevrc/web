---
import { getCollection } from "astro:content";
import PageHeading from "@components/decoratives/Headings/PageHeading.astro";
import ArticleDateShortcut from "@components/domains/article/ArticleDateShortcut/ArticleDateShortcut.astro";
import ArticleList from "@components/domains/article/ArticleList/ArticleList.astro";
import { getMeta } from "@content/meta";
import Layout from "@layouts/Layout.astro";
import { sortByDesc, unique } from "@lib/utils/array";
import { toAbsoluteUrl } from "@lib/utils/url";
import { css } from "@styles/css";

const {
  articles: { title, description, keywords, thumbnail },
} = await getMeta();

const articleCollection = sortByDesc(
  await getCollection("articles"),
  (article) => new Date(article.data.publishedAt).getTime(),
);

const articles = articleCollection.map((article) => article.data);

// 2023-04 のような年月のリストを取り出す（既にソート済みなので重複削除のみ）
const dateShortcuts = unique(
  articleCollection.map((article): `${number}-${number}` => {
    const date = new Date(article.data.publishedAt);
    return `${date.getFullYear()}-${date.getMonth() + 1}`;
  }),
);

const mainClass = css({
  display: "flex",
  flexDir: "column",
  alignItems: "center",
});

const fitStyle = css({
  // grid にする. list がメインで、 date shortcut は aside になる
  display: "grid",
  gridTemplateColumns: "2fr 1fr",
  w: "full",
  paddingInline: "8",
  gap: "16",
  pt: "16",
  pb: "26",

  _pc: {
    gridTemplateColumns: "4fr 1fr",
    w: "256",
    paddingInline: "[inherit]",
    gap: "26",
  },
});
---

<Layout
  headMeta={{
    title,
    description,
    keywords,
  }}
  ogp={{
    title,
    type: "website",
    image: {
      url: thumbnail,
    },
  }}
  sns={{
    twitter: {
      title,
      description,
      image: thumbnail,
    },
  }}
  jsonLd={{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
      {
        "@type": "ListItem",
        position: 1,
        name: "ホーム",
        item: toAbsoluteUrl("/", Astro.site),
      },
      {
        "@type": "ListItem",
        position: 2,
        name: title,
        item: Astro.url.href,
      },
    ],
  }}
  defineShapes={["letter", "star"]}
  mainClass={mainClass}
>
  <PageHeading img={thumbnail}> {title} </PageHeading>
  <section class={fitStyle}>
    <ArticleList
      articles={articles}
      yearMonths={dateShortcuts}
      aria-label={title}
    />
    <ArticleDateShortcut yearMonths={dateShortcuts} aria-label="公開年月一覧" />
  </section>
</Layout>
