name: ğŸš€ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
description: Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ã—ã€çµæœã‚’ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

on:
  # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'

  # GitHub UIã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:

  # CMSã‹ã‚‰ã®æ›´æ–°é€šçŸ¥
  repository_dispatch:
    types: [update]

# GitHub Pagesã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’è¨­å®š
permissions:
  contents: read
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã¯æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã›ãšã€å¤ã„å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: ğŸ—ï¸ Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    environment: CMS_STACK_20250923
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ“ ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹é€šçŸ¥
      - name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹é€šçŸ¥
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'start'
          title: 'ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹'
          description: 'GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã—ãŸ'
          username: 'pple-web bot'

      # GitHub Pagesç”¨ã®è¨­å®šã‚’å–å¾—
      - name: âš™ï¸ GitHub Pagesè¨­å®šã‚’å–å¾—
        id: pages
        uses: actions/configure-pages@v5

      # Node.js + Yarn ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå…±é€šã®composite actionã‚’ä½¿ç”¨ï¼‰
      - name: ğŸ› ï¸ Node.js + Yarn ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ./.github/actions/setup-node-yarn

      # Astroãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ğŸ“¦ Astroãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ./.github/actions/setup-astro-cache

      # Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æœ¬ç•ªç”¨ã«ãƒ“ãƒ«ãƒ‰
      - name: ğŸ—ï¸ Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
        run: yarn build
        env:
          SITE_DOMAIN: ${{ secrets.SITE_DOMAIN }}
          SITE_BASE: ${{ secrets.SITE_BASE }}
          MOCK: ${{ vars.MOCK }}
          SITE_IS_PUBLIC: ${{ vars.SITE_IS_PUBLIC }}
          CONTENTS_API_KEY: ${{ secrets.CONTENTS_API_KEY }}
          CONTENTS_SERVICE_ID: ${{ secrets.CONTENTS_SERVICE_ID }}
          CONTENTS_CASTS_URL: ${{ secrets.CONTENTS_CASTS_URL }}
          CONTENTS_CASTS_API_KEY: ${{ secrets.CONTENTS_CASTS_API_KEY }}

      # GitHub Pagesç”¨ã«ãƒ“ãƒ«ãƒ‰çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ“¤ ãƒ“ãƒ«ãƒ‰çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    name: ğŸš€ GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    environment: CMS_STACK_20250923
    needs: build
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆé€šçŸ¥ç”¨ï¼‰
      - name: ğŸ“ ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: ğŸš€ GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4

      # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
      - name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        if: success()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'success'
          title: 'âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ'
          description: 'GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ'
          username: 'pple-web bot'

      # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
      - name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
        if: failure()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'failure'
          title: 'âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—'
          description: 'GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          username: 'pple-web bot'