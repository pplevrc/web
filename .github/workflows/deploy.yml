name: 🚀 GitHub Pages にデプロイ

on:
  # mainブランチにプッシュされた時に自動実行
  push:
    branches: [main]

  # GitHub UIから手動実行可能
  workflow_dispatch:

# GitHub Pagesへの書き込み権限を設定
permissions:
  contents: read
  pages: write
  id-token: write

# 同時実行制御：デプロイ中は新しいデプロイをキューに入れる（キャンセルしない）
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: 🏗️ Astroプロジェクトをビルド
    runs-on: ubuntu-latest
    steps:
      # リポジトリのコードをチェックアウト
      - name: 📁 コードをチェックアウト
        uses: actions/checkout@v4

      # デプロイ開始通知
      - name: 📢 デプロイ開始通知
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'start'
          title: '🚀 デプロイ開始'
          description: 'GitHub Pagesへのデプロイを開始しました'
          username: 'pple-web bot'

      # GitHub Pages用の設定を取得
      - name: ⚙️ GitHub Pages設定を取得
        id: pages
        uses: actions/configure-pages@v5

      # Node.js + Yarn セットアップ（共通のcomposite actionを使用）
      - name: 🛠️ Node.js + Yarn セットアップ
        uses: ./.github/actions/setup-node-yarn

      # Astroビルドキャッシュをセットアップ
      - name: 📦 Astroビルドキャッシュをセットアップ
        uses: ./.github/actions/setup-astro-cache

      # Astroプロジェクトを本番用にビルド
      - name: 🏗️ Astroプロジェクトをビルド
        run: yarn build

      # GitHub Pages用にビルド結果をアップロード
      - name: 📤 ビルド結果をアップロード
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    name: 🚀 GitHub Pagesにデプロイ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      # リポジトリのコードをチェックアウト（通知用）
      - name: 📁 コードをチェックアウト
        uses: actions/checkout@v4

      # GitHub Pagesにデプロイ
      - name: 🚀 GitHub Pagesにデプロイ
        id: deployment
        uses: actions/deploy-pages@v4

      # デプロイ成功通知
      - name: 📢 デプロイ成功通知
        if: success()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'success'
          title: '✅ デプロイ成功'
          description: 'GitHub Pagesへのデプロイが正常に完了しました'
          username: 'pple-web bot'

      # デプロイ失敗通知
      - name: 📢 デプロイ失敗通知
        if: failure()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'failure'
          title: '❌ デプロイ失敗'
          description: 'GitHub Pagesへのデプロイが失敗しました。ログを確認してください。'
          username: 'pple-web bot'