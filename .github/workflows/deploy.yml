name: 🚀 GitHub Pages にデプロイ
description: Astroプロジェクトをビルドし、結果を GitHub Pages にデプロイする

on:
  # mainブランチにプッシュされた時に自動実行
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'

  # GitHub UIから手動実行可能
  workflow_dispatch:

  # CMSからの更新通知
  repository_dispatch:
    types: [update]

# GitHub Pagesへの書き込み権限を設定
permissions:
  contents: read
  pages: write
  id-token: write

# 同時実行制御：デプロイ中は新しいデプロイを実行せず、古い実行をキャンセル
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  notify_start:
    name: 📢 デプロイ開始通知
    runs-on: ubuntu-latest
    steps:
      - name: 📁 コードをチェックアウト
        uses: actions/checkout@v4

      - name: 🔍 デプロイ起因を判定
        id: trigger
        run: |
          case "${{ github.event_name }}" in
            push)
              MESSAGE="ソースコードが更新されたので、"
              ;;
            repository_dispatch)
              MESSAGE="コンテンツが更新されたので、"
              ;;
            workflow_dispatch)
              MESSAGE="手動実行で"
              ;;
            *)
              MESSAGE=""
              ;;
          esac
          echo "message=${MESSAGE}" >> $GITHUB_OUTPUT

      - name: 📢 Discord通知を送信
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'start'
          content: |
            # 🚀 デプロイ始めるキプよ！

            ${{ steps.trigger.outputs.message }}デプロイ開始するよ！
          username: 'pple-web bot'

  build:
    name: 🏗️ Astroプロジェクトをビルド
    runs-on: ubuntu-latest
    environment: CMS_STACK_20250923
    needs: notify_start
    steps:
      # リポジトリのコードをチェックアウト
      - name: 📁 コードをチェックアウト
        uses: actions/checkout@v4

      # GitHub Pages用の設定を取得
      - name: ⚙️ GitHub Pages設定を取得
        id: pages
        uses: actions/configure-pages@v5

      # Node.js + Yarn セットアップ（共通のcomposite actionを使用）
      - name: 🛠️ Node.js + Yarn セットアップ
        uses: ./.github/actions/setup-node-yarn

      # Astroビルドキャッシュをセットアップ
      - name: 📦 Astroビルドキャッシュをセットアップ
        uses: ./.github/actions/setup-astro-cache

      # Astroプロジェクトを本番用にビルド
      - name: 🏗️ Astroプロジェクトをビルド
        run: yarn build
        env:
          SITE_DOMAIN: ${{ secrets.SITE_DOMAIN }}
          SITE_BASE: ${{ secrets.SITE_BASE }}
          MOCK: ${{ vars.MOCK }}
          SITE_IS_PUBLIC: ${{ vars.SITE_IS_PUBLIC }}
          CONTENTS_API_KEY: ${{ secrets.CONTENTS_API_KEY }}
          CONTENTS_SERVICE_ID: ${{ secrets.CONTENTS_SERVICE_ID }}
          CONTENTS_CASTS_URL: ${{ secrets.CONTENTS_CASTS_URL }}
          CONTENTS_CASTS_API_KEY: ${{ secrets.CONTENTS_CASTS_API_KEY }}

      # GitHub Pages用にビルド結果をアップロード
      - name: 📤 ビルド結果をアップロード
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      # ビルド失敗通知
      - name: 📢 ビルド失敗通知
        if: failure()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'failure'
          content: |
            # ❌ やばばば！ ビルド失敗したキプよ！

            やべーよやべーよ
            Astroプロジェクトのビルドが失敗しちゃったみたい...
            ログ見て確認してね！
          username: 'ウェブサイト更新おしらせキプ'

  deploy:
    name: 🚀 GitHub Pagesにデプロイ
    runs-on: ubuntu-latest
    environment: CMS_STACK_20250923
    needs: build
    steps:
      # リポジトリのコードをチェックアウト（通知用）
      - name: 📁 コードをチェックアウト
        uses: actions/checkout@v4

      # GitHub Pagesにデプロイ
      - name: 🚀 GitHub Pagesにデプロイ
        id: deployment
        uses: actions/deploy-pages@v4

      # デプロイ成功通知
      - name: 📢 デプロイ成功通知
        if: success()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'success'
          content: |
            # ✅ デプロイ完了したキプよ！

            無事にGitHub Pagesへデプロイできたね！
            サイト見てみてね〜

            🌐 サイト: ${{ secrets.SITE_DOMAIN }}${{ secrets.SITE_BASE }}
          username: 'ウェブサイト更新完了お知らせキプ'

      # デプロイ失敗通知
      - name: 📢 デプロイ失敗通知
        if: failure()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'failure'
          content: |
            # ❌ やばばば！ デプロイ失敗したキプよ！

            やべーよやべーよ
            GitHub Pagesへのデプロイが失敗しちゃった...
            ログ見て確認してね！

            🔗 ログ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: 'ウェブサイト更新失敗お知らせキプ'