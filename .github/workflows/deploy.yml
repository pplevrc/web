name: ğŸš€ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
description: Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ã—ã€çµæœã‚’ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

on:
  # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'

  # GitHub UIã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:

  # CMSã‹ã‚‰ã®æ›´æ–°é€šçŸ¥
  repository_dispatch:
    types: [update]

# GitHub Pagesã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’è¨­å®š
permissions:
  contents: read
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã¯æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã›ãšã€å¤ã„å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  notify_start:
    name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹é€šçŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤èµ·å› ã‚’åˆ¤å®š
        id: trigger
        run: |
          case "${{ github.event_name }}" in
            push)
              MESSAGE="ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚ŒãŸã®ã§ã€"
              ;;
            repository_dispatch)
              MESSAGE="ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ›´æ–°ã•ã‚ŒãŸã®ã§ã€"
              ;;
            workflow_dispatch)
              MESSAGE="æ‰‹å‹•å®Ÿè¡Œã§"
              ;;
            *)
              MESSAGE=""
              ;;
          esac
          echo "message=${MESSAGE}" >> $GITHUB_OUTPUT

      - name: ğŸ“¢ Discordé€šçŸ¥ã‚’é€ä¿¡
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'start'
          content: |
            # ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å§‹ã‚ã‚‹ã‚­ãƒ—ã‚ˆï¼

            ${{ steps.trigger.outputs.message }}ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ã™ã‚‹ã‚ˆï¼
          username: 'pple-web bot'

  build:
    name: ğŸ—ï¸ Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    environment: CMS_STACK_20250923
    needs: notify_start
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ“ ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # GitHub Pagesç”¨ã®è¨­å®šã‚’å–å¾—
      - name: âš™ï¸ GitHub Pagesè¨­å®šã‚’å–å¾—
        id: pages
        uses: actions/configure-pages@v5

      # Node.js + Yarn ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå…±é€šã®composite actionã‚’ä½¿ç”¨ï¼‰
      - name: ğŸ› ï¸ Node.js + Yarn ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ./.github/actions/setup-node-yarn

      # Astroãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ğŸ“¦ Astroãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ./.github/actions/setup-astro-cache

      # Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æœ¬ç•ªç”¨ã«ãƒ“ãƒ«ãƒ‰
      - name: ğŸ—ï¸ Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
        run: yarn build
        env:
          SITE_DOMAIN: ${{ secrets.SITE_DOMAIN }}
          SITE_BASE: ${{ secrets.SITE_BASE }}
          MOCK: ${{ vars.MOCK }}
          SITE_IS_PUBLIC: ${{ vars.SITE_IS_PUBLIC }}
          CONTENTS_API_KEY: ${{ secrets.CONTENTS_API_KEY }}
          CONTENTS_SERVICE_ID: ${{ secrets.CONTENTS_SERVICE_ID }}
          CONTENTS_CASTS_URL: ${{ secrets.CONTENTS_CASTS_URL }}
          CONTENTS_CASTS_API_KEY: ${{ secrets.CONTENTS_CASTS_API_KEY }}

      # GitHub Pagesç”¨ã«ãƒ“ãƒ«ãƒ‰çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ“¤ ãƒ“ãƒ«ãƒ‰çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      # ãƒ“ãƒ«ãƒ‰å¤±æ•—é€šçŸ¥
      - name: ğŸ“¢ ãƒ“ãƒ«ãƒ‰å¤±æ•—é€šçŸ¥
        if: failure()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'failure'
          content: |
            # âŒ ã‚„ã°ã°ã°ï¼ ãƒ“ãƒ«ãƒ‰å¤±æ•—ã—ãŸã‚­ãƒ—ã‚ˆï¼

            ã‚„ã¹ãƒ¼ã‚ˆã‚„ã¹ãƒ¼ã‚ˆ
            Astroãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¡ã‚ƒã£ãŸã¿ãŸã„...
            ãƒ­ã‚°è¦‹ã¦ç¢ºèªã—ã¦ã­ï¼
          username: 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆæ›´æ–°ãŠã—ã‚‰ã›ã‚­ãƒ—'

  deploy:
    name: ğŸš€ GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    environment: CMS_STACK_20250923
    needs: build
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆé€šçŸ¥ç”¨ï¼‰
      - name: ğŸ“ ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: ğŸš€ GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4

      # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
      - name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        if: success()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'success'
          content: |
            # âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã—ãŸã‚­ãƒ—ã‚ˆï¼

            ç„¡äº‹ã«GitHub Pagesã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããŸã­ï¼
            ã‚µã‚¤ãƒˆè¦‹ã¦ã¿ã¦ã­ã€œ

            ğŸŒ ã‚µã‚¤ãƒˆ: ${{ secrets.SITE_DOMAIN }}${{ secrets.SITE_BASE }}
          username: 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆæ›´æ–°å®Œäº†ãŠçŸ¥ã‚‰ã›ã‚­ãƒ—'

      # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
      - name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
        if: failure()
        uses: ./.github/actions/discord-notification
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'failure'
          content: |
            # âŒ ã‚„ã°ã°ã°ï¼ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã—ãŸã‚­ãƒ—ã‚ˆï¼

            ã‚„ã¹ãƒ¼ã‚ˆã‚„ã¹ãƒ¼ã‚ˆ
            GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¡ã‚ƒã£ãŸ...
            ãƒ­ã‚°è¦‹ã¦ç¢ºèªã—ã¦ã­ï¼

            ğŸ”— ãƒ­ã‚°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆæ›´æ–°å¤±æ•—ãŠçŸ¥ã‚‰ã›ã‚­ãƒ—'