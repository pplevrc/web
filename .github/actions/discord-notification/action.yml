name: Discordé€šçŸ¥
description: ãƒ“ãƒ«ãƒ‰çµæœãªã©ã®è©³ç´°æƒ…å ±ã‚’ Discord ã«é€šçŸ¥

inputs:
  webhook_url:
    description: Discord Webhook URL
    required: true
  status:
    description: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè‰²é¸æŠç”¨: start, success, failureï¼‰"
    required: true
  content:
    description: Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ï¼ˆMarkdownå½¢å¼ï¼‰
    required: true
  username:
    description: Discordã«è¡¨ç¤ºã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    required: false
    default: GitHub Actions

runs:
  using: 'composite'
  steps:
    # Discordé€šçŸ¥ã‚’é€ä¿¡
    - name: ğŸ“¢ Discordé€šçŸ¥ã‚’é€ä¿¡
      run: |
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²ã‚’è¨­å®š
        case "${{ inputs.status }}" in
          start)
            COLOR="3447003"  # é’è‰²
            ;;
          success)
            COLOR="3066993"  # ç·‘è‰²
            ;;
          failure)
            COLOR="15158332"  # èµ¤è‰²
            ;;
          *)
            COLOR="10181046"  # ã‚°ãƒ¬ãƒ¼è‰²
            ;;
        esac

        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ï¼ˆæœ€åˆã®è¡Œã®ã¿ï¼‰
        COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s' 2>/dev/null || echo "N/A")

        # ã‚³ãƒŸãƒƒãƒˆè€…æƒ…å ±ã®å–å¾—
        COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an' 2>/dev/null || echo "N/A")

        # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆISO 8601å½¢å¼ï¼‰
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # Discord Webhookç”¨ã®JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
        # jqã‚’ä½¿ã£ã¦å®‰å…¨ã«JSONç”Ÿæˆ
        PAYLOAD=$(jq -n \
          --arg username "${{ inputs.username }}" \
          --arg content "${{ inputs.content }}" \
          --argjson color "${COLOR}" \
          --arg repo "${{ github.repository }}" \
          --arg branch "${{ github.ref_name }}" \
          --arg sha "${{ github.sha }}" \
          --arg short_sha "${GITHUB_SHA:0:7}" \
          --arg commit_url "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" \
          --arg actor "${{ github.actor }}" \
          --arg workflow "${{ github.workflow }}" \
          --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          --arg timestamp "${TIMESTAMP}" \
          --arg commit_msg "${COMMIT_MESSAGE}" \
          --arg commit_author "${COMMIT_AUTHOR}" \
          '{
            username: $username,
            content: $content,
            embeds: [{
              color: $color,
              fields: [
                {
                  name: "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ",
                  value: $branch,
                  inline: true
                },
                {
                  name: "ğŸ‘¤ å®Ÿè¡Œè€…",
                  value: $actor,
                  inline: true
                },
                {
                  name: "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ",
                  value: ("[\($short_sha)](\($commit_url))"),
                  inline: true
                },
                {
                  name: "âœï¸ ã‚³ãƒŸãƒƒãƒˆè€…",
                  value: $commit_author,
                  inline: true
                },
                {
                  name: "ğŸ”— ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼",
                  value: ("[\($workflow)](\($run_url))"),
                  inline: true
                },
                {
                  name: "ğŸ•’ æ›´æ–°æ—¥æ™‚",
                  value: $timestamp,
                  inline: true
                },
                {
                  name: "ğŸ’¬ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
                  value: $commit_msg
                }
              ]
            }]
          }')

        # Discord Webhookã«é€ä¿¡
        if [ -n "${{ inputs.webhook_url }}" ]; then
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}" \
            "${{ inputs.webhook_url }}")

          if [ "$HTTP_STATUS" -eq 204 ]; then
            echo "âœ… Discordé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆStatus: ${HTTP_STATUS}ï¼‰"
          else
            echo "âš ï¸ Discordé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆStatus: ${HTTP_STATUS}ï¼‰"
          fi
        else
          echo "âš ï¸ Discord Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi
      shell: bash